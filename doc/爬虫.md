# 爬虫模块（we123 小程序采集）

目标
- 在服务端 app 中新增一个“爬虫模块”，用于基于浏览器的页面采集
- 采用 DrissionPage 作为浏览器控制与页面采集基础库

本次调整
- 新增 we123 微信小程序采集需求设计与实施计划
- 保留统一的脚本运行与日志管理（/api/v1/crawler/script/* 已存在）

目录结构（后端建议）
- app/crawler/__init__.py：模块初始化与占位
- app/crawler/strategies/：不同站点/策略的采集实现（本需求新增 we123_xcx.py）
- app/crawler/services/：调度、去重、断点续爬、节流与告警
- app/crawler/adapters/：浏览器适配（DrissionPage）、解析适配（xpath/css/正则）

API 规划（在现有 /crawler/script 基础上扩展）
- /api/v1/crawler/task/we123/start：启动采集，参数如下
  - start_id: 起始 id（默认 1）
  - loop: 是否循环爬取（默认 false）。当连续 404 超过阈值时（默认 500），认为到达上限；若 loop=true，则从 1 重新向上增量更新
  - max_404_span: 连续 404 阈值（默认 500）
  - delay_sec: 每次请求最小间隔秒（默认 3）
  - ua: 自定义 User-Agent（可选）
  - proxy: 代理（可选）
- /api/v1/crawler/task/we123/stop：停止采集
- /api/v1/crawler/task/we123/status：查看当前状态（last_id、last_ok_id、consecutive_404、qps、近 5 分钟错误摘要等）
- /api/v1/crawler/task/we123/xpaths(get/update)：维护字段 xpath 配置（便于随时调试替换）

数据源与解析
- 目标地址： https://www.we123.com/xcx/{id} ，例如 id=1 对应 https://www.we123.com/xcx/1/
- 解析方式：使用 DrissionPage 拿到渲染完成的页面，优先用 xpath 抽取；xpath 可在线配置，便于你调试与快速修复
- 反爬与稳定性：
  - 固定最小间隔 delay_sec（默认 3s），并在服务端额外引入随机抖动（±0.5s）
  - 自定义 UA、可选代理、自动重试（网络/超时类），指数退避（最多 3 次）
  - 404 直接判定为不存在，不重试；非 2xx/3xx 的其他状态按错误重试

字段规划（对齐“小程序管理”并可扩展）
- 基础字段（建议必抓）
  - src_id（来源站点 id）、name（名称）、category（分类）、tags（标签，数组）、desc（简介）
  - icon_url（图标）、qrcode_url（小程序码）、screenshot_urls（截图数组）
  - developer（开发者/主体）、province/city/area（地域信息可空）
  - rating（评分/星级）、hot_value（热度/人气）、comment_count（评论数/评价数）
  - version（版本）、updated_at_src（来源页展示的更新时间，字符串或日期）、detail_url（来源链接）
- 扩展字段（保留扩展性）
  - ext_json（json，保留源页面结构化块/无法标准化的信息）
  - raw_html（可选，截断保存 N KB 以便回溯）
- 字段映射存储：写入既有 ODS 表（表名与字段请最终以现网表结构为准，可在上线前在配置中完成映射对齐）

运行策略
- 起始与递增：从 start_id 开始，逐个 id 递增访问
- 连续 404 判上限：连续超过 max_404_span（默认 500）个 id 返回 404，视作到达上限
  - loop=true：到达上限后回到 1，再做“增量更新”（若页面更新时间 updated_at_src 变化，则更新；否则跳过）
  - loop=false：任务结束
- 节流与随机等待：每次请求后 sleep delay_sec ±0.5s，避免被识别为爬虫
- 断点续爬：持久化 last_id、last_ok_id、consecutive_404、last_run_at 等，任务重启后自动续跑
- 错误处理：网络/超时指数退避重试，失败记录到运行日志与错误计数

配置（可在线调整）
- xpaths：可通过 /task/we123/xpaths 接口查看/更新，示例（待你调试确认）：
  - name:   //div[@class='xcxtop_logo']/h1/text()
  - category:  //a[contains(@href,'/xcxcat/')]/text()
  - tags:  //div[@class='tags']/a/text()
  - desc:  //div[contains(@class,'desc')]/text()
  - icon_url:  //div[contains(@class,'logo')]//img/@src
  - qrcode_url:  //img[contains(@alt,'小程序码')]/@src
  - screenshot_urls:  //div[contains(@class,'screenshots')]//img/@src
  - developer:  //li[contains(.,'开发者')]/span/text()
  - rating:  //span[contains(@class,'rating')]/text()
  - hot_value:  //span[contains(@class,'hot')]/text()
  - comment_count:  //span[contains(@class,'comments')]/text()
  - version:  //li[contains(.,'版本')]/span/text()
  - updated_at_src:  //li[contains(.,'更新')]/span/text()

数据写入与去重
- Key：src_id 唯一（来源 id）。已存在则按 src_id 做 upsert（对比字段：updated_at_src 或页面摘要 hash）
- 规范化：rating/hot_value 等字符串转数字；tags/screenshot_urls 规范为数组
- 容量控制：raw_html/ext_json 可配置最大长度，避免占用过多空间

上线与运维
- 先以低 QPS（3s/次）跑一轮，确认 ODS 填充正确后，再评估是否引入更快节奏
- 监控：统计成功/404/错误占比；当 404 占比异常升高、错误率突增时报警

对“1-6 点”设计的评审与建议
1) 目标落库到 ODS：合理。建议上线前对齐 ODS 表字段并明确主键/唯一键（建议 src_id 唯一）。
2) /xcx/{id} 地址模型明确：合理。
3) 解析使用 DrissionPage + xpath 且 xpath 可配置：合理，强烈建议把 xpath 放到可热更新配置里（本文已规划）。
4) 连续 404 超过 500 判上限并可循环：思路合理。建议将 500 作为默认可调参数；循环模式下做“仅更新变化”的增量策略，避免全量重复写。
5) 3 秒节流：合理。建议增加 ±0.5 秒随机抖动和指数退避，进一步弱化固定节奏特征。
6) 字段覆盖：已在“字段规划”中按管理需求+扩展性设计。建议保留 ext_json 和 raw_html（截断）以便回溯解析问题。

后续实现里程碑（建议）
- M1：落地 we123_xcx 策略（顺序调度、断点续爬、上面字段抽取、ODS upsert）
- M2：后台配置页（xpath、delay、proxy、loop 开关等）与任务控制接口（start/stop/status）
- M3：稳定性与监控（速率、错误、404 连续段、字段缺失率）
