# 项目进度记录

## 2025-11-11

### 小程序前台接口（wxapp）框架接入

- ✅ 后端：新增并挂载 /api/v1/wxapp 路由命名空间（APIRouter）
- ✅ 占位接口：/auth/login、/home、/list、/categories、/favorite/list、/favorite/toggle、/favorite/pin、/qr、/track/event
- ✅ 最小数据接入：
  - /home、/list 查询 WechatApp 表（过滤 is_deleted=false），返回统一字段映射
  - /qr 可根据 id 或 appid 返回 qrcode_url；无则空字符串兜底
- ✅ 鉴权接入：
  - 写接口（/favorite/*、/track/event）接入 DependAuth（header: token）
  - 登录暂返回 token="dev"（AuthControl 对 dev 直通首个用户）；后续接入 code2session + 自动授予“葡萄用户”
- ✅ 前端（guide）：
  - 新增 utils/wxapp_api.js（命名空间适配 + normalize + mapWechatApp）
  - 新增 utils/track.js（批量上报节流）
  - 新增组件 app-card、qr-modal、search-bar，并在首页/收藏以 featureNewUI 开关试接入（默认关闭）

### 待办（下一步）

1) 数据与鉴权（后端）
- [ ] /auth/login 对接 wx.login code2session；首次登录自动注册“葡萄用户”
- [ ] /favorite/* 持久化 Favorite；/track/event 落库 Event
- [ ] /categories、/home.banners 对接 Category/Banner（占位返回 → 真实数据）

2) 前端 API 替换（guide）
- [ ] 首页/收藏页调用替换为 wxapp_api（保留回退开关）
- [ ] 曝光/点击/搜索等埋点接入 utils/track.js

3) 数据库迁移（Tortoise + Aerich）
- [ ] 新增 Category/Banner/Favorite/Event 表（含索引）
- [ ] WechatApp 增加 category_id、is_top、jump_path（或扩展表）
- [ ] 产出 aerich migrate/upgrade 脚本与回滚说明

---

## 2025-11-10

### 数据库配置切换到 MySQL

- ✅ 已将数据库从 SQLite 切换到 MySQL
- ✅ MySQL 连接信息：
  - Host: 152.32.173.226
  - Port: 3306
  - Database: myweb_dev2
  - User: root
- ✅ 已安装 `aiomysql` (v0.3.2) - MySQL 异步驱动
- ✅ 已安装 `aerich` (v0.9.2) - Tortoise ORM 迁移工具
- ✅ 数据库已初始化完成
- ✅ 已创建并配置 Python 虚拟环境 (venv)
- ✅ 已在虚拟环境中安装所有后端依赖
- ✅ 后端服务已验证可正常启动
- ✅ 前端依赖已存在

### 待办事项

- [ ] 启动后端服务 (FastAPI on port 9999)
- [ ] 启动前端服务 (Vue on port 3100)

## 小程序管理模块（mywechat）

### 当前状态（2025-11-10）

**后端已完成**：
- ✅ 数据模型 WechatApp（表名 MyWechat）
- ✅ 基础 CRUD 接口（list/get/create/update/delete）
- ✅ 发布状态管理（update_status）
- ✅ Logo/二维码 URL 更新接口
- ✅ 软删除机制（is_deleted）
- ✅ 菜单与权限初始化（ensure_wechat_menu）

**前端已完成**：
- ✅ 页面骨架（web/src/views/system/wechat/index.vue）
- ✅ 基础 CRUD 表单与表格
- ✅ 发布状态切换开关
- ✅ 查询筛选（名称/AppID/状态）
- ✅ API 接口封装（web/src/api/index.js）
- ✅ 小程序列表已正常显示
- ✅ 图片上传功能已修复

**待完善功能**：
- ✅ 后端：静态文件服务挂载（/static）
- ✅ 后端：文件上传接口（/api/v1/wechat/upload）
- ✅ 后端：恢复接口（/api/v1/wechat/restore）
- ✅ 后端：列表查询扩展（include_deleted/only_deleted 参数）
- ✅ 前端：上传控件集成（NUpload + custom-request）
- ✅ 前端：删除/恢复按钮切换逻辑
- ✅ 前端："显示已删除"查询开关
- ✅ 前端：版本字段只读展示
- ✅ 前端：移除 v-permission 指令依赖

### 本次改造计划

**后端改造**：
1. 配置静态资源目录与上传限制（app/settings/config.py）
2. 挂载 StaticFiles 中间件（app/__init__.py）
3. 新增文件上传工具（app/utils/file.py）
4. 实现上传接口 POST /api/v1/wechat/upload
5. 实现恢复接口 POST /api/v1/wechat/restore
6. 扩展列表接口支持 include_deleted/only_deleted

**前端改造**：
1. 封装上传 API（uploadWechatFile）
2. 封装恢复 API（restoreWechat）
3. 页面集成上传控件（Logo/二维码）
4. 操作列动态显示删除/恢复按钮
5. 查询区新增"显示已删除"开关
6. 版本字段设为只读
7. 移除按钮级权限指令

**文档交付**：
- ✅ 需求文档（doc/需求.md）
- ✅ 进度文档更新（本文档）

### 状态更新（2025-11-11）

- 前端：小程序列表与图片预览均正常显示
- 后端：上传接口与静态资源访问已通过手测验证

### 问题修复（2025-11-11）

**上传图片错误问题**：
- ✅ 修复了文件上传时的异步读取问题
- ✅ 将 `save_upload_file` 函数改为异步，使用 `await file.read()`
- ✅ 简化文件读取逻辑，一次性读取整个文件
- ✅ 更新了 wechat 路由中的调用，使用 `await save_upload_file()`
- ✅ 修复了 `restoreWechat` API 调用，从 query 参数改为 body 参数
- ✅ 添加了 `WechatRestore` schema
- ✅ 放宽了 MIME 类型验证，允许空 content_type
- ✅ 添加了详细的错误日志和异常捕获
- ✅ **修复 UnicodeDecodeError**：问题出在中间件，而不是上传接口本身
- ✅ 修改 `HttpAuditLogMiddleware` 在解析请求体前先检查 Content-Type
- ✅ 对 multipart/form-data 请求使用 `request.form()` 而不是 `request.json()`
- ✅ 使用固定的 base URL 构建图片访问地址

**测试方法**：
```powershell
# 1. 重启后端服务
python run.py

# 2. 运行测试脚本
python test_upload.py

# 3. 或者使用 curl 测试
curl -X POST -F "file=@test.png" -F "kind=logo" http://localhost:9999/api/v1/wechat/upload
```

**注意事项**：
- 确保后端服务在 9999 端口运行
- 确保 `static/uploads/wechat/logo` 和 `static/uploads/wechat/qrcode` 目录存在并可写
- 如果仍然报错，查看后端控制台输出的详细错误信息

### 验收标准

- [x] 上传图片成功返回可访问的完整 URL
- [x] 浏览器可直接访问上传的图片 URL
- [x] Logo/二维码上传后自动回填表单并预览
- [ ] 删除后默认列表不可见
- [ ] 勾选"显示已删除"后可见已删除记录
- [ ] 点击"恢复"后记录回到正常列表
- [ ] 发布状态切换仅系统内生效
- [ ] 版本字段只读展示不可编辑
- [ ] 所有接口通过 curl/Postman 验证

### 技术要点

**文件上传安全**：
- 限制文件类型：png/jpg/jpeg/webp
- 限制文件大小：≤5MB
- 随机文件名：时间戳 + UUID
- 防止目录穿越攻击

**权限策略**：
- 沿用系统默认权限，不新增独立角色
- 前端按钮常显，后端 API 控制实际权限
- 管理员全权限，普通用户仅 GET 权限

**数据一致性**：
- appid 唯一约束（数据库 + 应用层）
- 软删除确保数据可追溯与恢复
- version 字段仅展示用途

### 启动命令参考

**后端启动：**
```powershell
python run.py
```

**前端启动：**
```powershell
cd web
pnpm install  # 首次需要安装依赖
pnpm dev
```

### 注意事项

- Python 版本: 3.11.4
- 数据库配置文件: `app/settings/config.py`
- MySQL 服务器可访问性已验证
