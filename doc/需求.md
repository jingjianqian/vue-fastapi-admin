# 小程序管理模块（mywechat）需求说明

## 1. 背景与目标

在不接入微信开放平台的前提下,于本系统内实现对小程序的增删改查与发布状态管理,并支持 Logo 与二维码图片上传展示;保留软删除与恢复能力;版本号仅作展示用途。

## 2. 功能范围

### 2.1 范围内功能

- **基础 CRUD**:新增、查询、修改、删除（软删除）、恢复
- **发布状态管理**:系统内管理发布状态流转（draft/review/published/disabled）,不对接微信开放平台真实发布流程
- **文件上传**:支持 Logo、二维码图片上传,上传后返回可访问的完整 URL
- **版本管理**:version 字段仅作展示用途,不参与业务逻辑
- **软删除与恢复**:删除操作仅标记 is_deleted=true,支持恢复到正常状态

### 2.2 范围外功能

- 不进行微信小程序开放平台的真实发布流程
- 不对接微信开放平台的代码上传、提交审核、发布上线等接口
- 不实现审核状态查询与回调处理
- 不实现版本自动管理与变更记录

## 3. 权限策略

- **沿用系统默认权限**:不新增独立的小程序管理角色或按钮级权限策略
- **前端处理**:不强依赖 v-permission 指令,按钮常显,由后端 API 权限控制实际操作权限
- **后端控制**:按系统既有 API 权限机制判定是否可执行操作（管理员全权限,普通用户仅 GET 权限）

## 4. 数据结构

### 4.1 核心字段

| 字段名 | 类型 | 必填 | 说明 |
|--------|------|------|------|
| id | int | 是 | 主键,自增 |
| name | string(64) | 是 | 小程序名称 |
| appid | string(64) | 是 | 小程序 AppID,唯一索引 |
| secret | string(128) | 是 | 小程序 AppSecret |
| logo_url | string(255) | 否 | 小程序图标 URL |
| qrcode_url | string(255) | 否 | 小程序二维码 URL |
| description | text | 否 | 描述信息 |
| version | string(32) | 否 | 版本号（仅展示） |
| publish_status | enum | 是 | 发布状态:draft/review/published/disabled |
| is_deleted | boolean | 是 | 软删除标记,默认 false |
| created_at | datetime | 是 | 创建时间 |
| updated_at | datetime | 是 | 更新时间 |

### 4.2 发布状态枚举

- **draft**:草稿
- **review**:审核中
- **published**:已发布
- **disabled**:已下线/禁用

## 5. 接口说明

### 5.1 列表查询

**请求**
```
GET /api/v1/wechat/list
```

**参数**
- `page` (int):页码,默认 1
- `page_size` (int):每页数量,默认 10
- `name` (string,可选):名称模糊查询
- `appid` (string,可选):AppID 模糊查询
- `publish_status` (enum,可选):发布状态筛选
- `include_deleted` (bool,可选):是否包含已删除记录,默认 false
- `only_deleted` (bool,可选):仅显示已删除记录,默认 false

**响应**
```json
{
  "data": [...],
  "total": 100,
  "page": 1,
  "page_size": 10
}
```

### 5.2 详情查询

**请求**
```
GET /api/v1/wechat/get?id=1
```

**响应**
```json
{
  "data": {
    "id": 1,
    "name": "示例小程序",
    "appid": "wx1234567890abcdef",
    ...
  }
}
```

### 5.3 创建小程序

**请求**
```
POST /api/v1/wechat/create
Content-Type: application/json

{
  "name": "我的小程序",
  "appid": "wx1234567890abcdef",
  "secret": "your_app_secret",
  "logo_url": "https://example.com/logo.png",
  "qrcode_url": "https://example.com/qrcode.png",
  "description": "描述信息",
  "version": "1.0.0",
  "publish_status": "draft"
}
```

**校验规则**
- appid 必须唯一,若已存在则返回 400 错误

### 5.4 更新小程序

**请求**
```
POST /api/v1/wechat/update
Content-Type: application/json

{
  "id": 1,
  "name": "更新后的名称",
  "version": "1.0.1",
  ...
}
```

**校验规则**
- 若修改 appid,需校验新 appid 是否与其他记录冲突

### 5.5 删除小程序（软删除）

**请求**
```
DELETE /api/v1/wechat/delete?id=1
```

**行为**
- 仅将 is_deleted 设置为 true
- 默认列表查询自动过滤已删除记录

### 5.6 恢复小程序

**请求**
```
POST /api/v1/wechat/restore
Content-Type: application/json

{
  "id": 1
}
```

**行为**
- 将 is_deleted 设置为 false
- 恢复后记录重新出现在默认列表中

### 5.7 更新 Logo

**请求**
```
POST /api/v1/wechat/update_logo
Content-Type: application/json

{
  "id": 1,
  "logo_url": "https://example.com/new_logo.png"
}
```

### 5.8 更新二维码

**请求**
```
POST /api/v1/wechat/update_qrcode
Content-Type: application/json

{
  "id": 1,
  "qrcode_url": "https://example.com/new_qrcode.png"
}
```

### 5.9 更新发布状态

**请求**
```
POST /api/v1/wechat/update_status
Content-Type: application/json

{
  "id": 1,
  "publish_status": "published"
}
```

### 5.10 文件上传

**请求**
```
POST /api/v1/wechat/upload
Content-Type: multipart/form-data

file: [图片文件]
kind: logo  (可选:logo|qrcode)
```

**响应**
```json
{
  "url": "http://localhost:9999/static/uploads/wechat/logo/logo_1699999999999_abc123.png",
  "path": "uploads/wechat/logo/logo_1699999999999_abc123.png",
  "filename": "my_logo.png",
  "kind": "logo"
}
```

**限制**
- 允许的图片格式:png、jpg、jpeg、webp
- 文件大小上限:5MB
- 文件名自动生成唯一标识,防止覆盖

## 6. 前端交互说明

### 6.1 列表页面

**查询功能**
- 名称模糊搜索
- AppID 模糊搜索
- 发布状态筛选（下拉选择）
- "显示已删除"开关（include_deleted）
- "仅已删除"开关（only_deleted）

**表格展示**
- ID、名称、AppID、Secret、版本、描述
- Logo 图片预览（NImage 组件）
- 二维码图片预览（NImage 组件）
- 发布状态标签（不同颜色区分）
- 删除标记（是/否）
- 创建时间、更新时间
- 发布状态切换开关（published/disabled）

**操作按钮**
- 根据 is_deleted 动态显示:
  - is_deleted === false:显示"编辑"、"删除"按钮
  - is_deleted === true:显示"恢复"按钮
- 所有操作均带二次确认（NPopconfirm）

### 6.2 新增/编辑表单

**基础信息**
- 名称（必填）
- AppID（必填,创建时唯一校验）
- AppSecret（必填）
- 版本号（只读展示,不可编辑）
- 发布状态（下拉选择）
- 描述（多行文本）

**图片上传**
- Logo URL:
  - 支持文件上传（点击上传按钮）
  - 上传成功后自动回填 URL
  - 支持手动输入 URL 覆盖上传结果
  - 上传后实时预览图片
- 二维码 URL:
  - 同 Logo URL 处理方式

**表单校验**
- name、appid、secret 为必填项
- version 不参与校验

**上传交互**
- 支持拖拽上传
- 上传中显示进度
- 上传成功后显示预览图
- 上传失败提示错误信息

### 6.3 状态管理

**发布状态流转**
- 草稿（draft） → 审核中（review）
- 审核中（review） → 已发布（published）
- 已发布（published） → 已下线（disabled）
- 任意状态 → 草稿（draft）

**状态切换开关**
- 列表中提供快速切换开关
- 切换时仅支持 published ⇄ disabled
- 其他状态变更需进入编辑表单操作

### 6.4 删除与恢复

**删除操作**
- 点击"删除"按钮弹出二次确认
- 确认后执行软删除（is_deleted=true）
- 删除后该记录从默认列表中消失

**恢复操作**
- 勾选"显示已删除"后可见已删除记录
- 已删除记录显示"恢复"按钮
- 点击"恢复"后记录重新出现在正常列表中

## 7. 上传文件说明

### 7.1 上传限制

- **允许的文件类型**:
  - 扩展名:png、jpg、jpeg、webp
  - MIME 类型:image/png、image/jpeg、image/webp
- **文件大小**:最大 5MB
- **文件命名**:自动生成唯一文件名（时间戳 + UUID）

### 7.2 存储路径

- **静态文件根目录**:`/static`
- **上传文件目录**:`/static/uploads/wechat/`
- **Logo 子目录**:`/static/uploads/wechat/logo/`
- **二维码子目录**:`/static/uploads/wechat/qrcode/`

### 7.3 URL 格式

完整 URL 示例:
```
http://localhost:9999/static/uploads/wechat/logo/logo_1699999999999_abc123def456.png
```

## 8. 验收标准

### 8.1 功能验收

- [ ] 新增小程序成功,appid 唯一校验生效
- [ ] 编辑小程序成功,支持部分字段更新
- [ ] 删除小程序后默认列表不可见
- [ ] 勾选"显示已删除"后可见已删除记录
- [ ] 点击"恢复"后记录重新出现在正常列表
- [ ] 发布状态切换成功,系统内立即生效
- [ ] 列表查询的各项筛选条件正常工作

### 8.2 上传验收

- [ ] 上传图片成功返回完整可访问 URL
- [ ] 在浏览器直接访问返回的 URL 可正常显示图片
- [ ] 上传后 Logo/二维码 URL 自动回填到表单
- [ ] 表单中可实时预览上传的图片
- [ ] 上传非图片文件被拒绝
- [ ] 上传超过 5MB 文件被拒绝

### 8.3 交互验收

- [ ] 版本字段在表单中为只读状态
- [ ] 删除操作有二次确认提示
- [ ] 恢复操作有二次确认提示
- [ ] 所有操作成功后有成功提示
- [ ] 所有操作失败后有错误提示

### 8.4 接口验收

使用 Postman 或 curl 验证关键接口:

**上传测试**
```bash
curl -F "file=@test_logo.png" -F "kind=logo" http://localhost:9999/api/v1/wechat/upload
```

**恢复测试**
```bash
curl -X POST -H "Content-Type: application/json" -d '{"id":1}' http://localhost:9999/api/v1/wechat/restore
```

**列表筛选测试**
```bash
# 包含已删除
curl "http://localhost:9999/api/v1/wechat/list?include_deleted=true"

# 仅已删除
curl "http://localhost:9999/api/v1/wechat/list?only_deleted=true"
```

## 9. 注意事项

1. **文件安全**:
   - 严格限制上传文件类型与大小
   - 使用随机文件名防止文件覆盖
   - 防止目录穿越攻击

2. **权限控制**:
   - 后端严格按 API 权限控制操作
   - 前端按钮常显但实际操作受后端控制

3. **数据一致性**:
   - appid 唯一约束在数据库层与应用层双重保障
   - 软删除确保数据可追溯与恢复

4. **版本管理**:
   - version 字段目前仅展示用途
   - 后续可扩展为自动版本管理机制

5. **发布流程**:
   - 当前为系统内状态管理
   - 未来可扩展对接微信开放平台真实发布流程
